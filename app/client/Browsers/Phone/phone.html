<html>
    <meta charset="utf-8">
    
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <script src="../vue.js"></script>
    <script src="../moment.js"></script>

    <script src="js/autosize.js"></script>
	<body>
		<div id="app">
            <div class="phone" style="background: url('images/wallpaper.png'); background-size: 100% 100%;">
                <img src="images/iphone-x.png">

                <div class="phone-messages animated zoomIn faster" v-if="currentTab === 3">
                    <div class="head">
                        <h1>Messages</h1>
                        <i class="fa fa-comment"></i>
                    </div>  
                    <ul>
                        <li v-for="(talk, i) in d.talks" :class="[{ active: currentLi === i }]">
                            <div class="avatar">NA</div>
                            <h3 v-if="phone == talk.sender">{{ talk.receiver }}</h3>
                            <h3 v-else>{{ talk.sender }}</h3>
                            <span class="time">{{ talk.time | format }}</span>
                            <i class="fa fa-chevron-right"></i>
                            <p>{{ talk.text }}</p>
                        </li>
                    </ul>
                </div>

                <div class="phone-conversation" v-if="currentTab === 30">
                    <div class="head">
                        <i class="fa fa-chevron-left"></i>
                        <h1>{{ talkNumber }}</h1>
                    </div>
                    <div id="chat" class="chat">
                        <div v-for="(msg, j) in d.messages" class="messages" :class="{ 'mine' : msg.sender == phone, 'yours' : msg.sender != phone}">
                            <div class="message last">
                                {{ msg.text }}
                            </div>
                        </div>
                        <!-- <div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                                <div class="message last">
                                    sdfsdfds
                                </div>
                            </div><div class="messages mine">
                                    <div class="message last">
                                        sdfsdfds
                                    </div>
                                </div><div class="messages mine">
                                        <div class="message last">
                                            sdfsdfds
                                        </div>
                                    </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                                <div class="message last">
                                    sdfsdfds
                                </div>
                            </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                                <div class="message last">
                                    sdfsdfds
                                </div>
                            </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                                <div class="message last">
                                    sdfsdfds
                                </div>
                            </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                                <div class="message last">
                                    sdfsdfds
                                </div>
                            </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                                <div class="message last">
                                    sdfsdfds
                                </div>
                            </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                                <div class="message last">
                                    sdfsdfds
                                </div>
                            </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div><div class="messages mine">
                            <div class="message last">
                                sdfsdfds
                            </div>
                        </div> -->
                        <br><br><br><br>
                    </div>
                    <div class="reply" id="reply-div">
                        <textarea id="reply" rows="3" v-model="textMessage"></textarea>
                        <button class="send" type="button" id="btnSms"><i class="fa fa-arrow-up"></i></button>
                    </div>
                </div>

                <div class="phone-calls animated zoomIn faster" v-if="currentTab === 2">
                    
                </div>

                
                
                <div class="phone-footer" v-if="currentTab === 0">
                    <a class="contact" :class="{ 'active' : homeFooterSelection == 1}"></a>
                    <a class="call" :class="{ 'active' : homeFooterSelection == 2}"></a>
                    <a class="sms" :class="{ 'active' : homeFooterSelection == 3}"></a>
                    <a class="cog" :class="{ 'active' : homeFooterSelection == 4}"></a>
                </div>
            </div>
		</div>
	</body>
</html>



<script>
moment.locale("fr",{months:"janvier_février_mars_avril_mai_juin_juillet_août_septembre_octobre_novembre_décembre".split("_"),monthsShort:"janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.".split("_"),monthsParseExact:!0,weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Je_Ve_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Aujourd’hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"dddd [dernier à] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},dayOfMonthOrdinalParse:/\d{1,2}(er|e)/,ordinal:function(e){return e+(1===e?"er":"e")},meridiemParse:/PD|MD/,isPM:function(e){return"M"===e.charAt(0)},meridiem:function(e,a,r){return e<12?"PD":"MD"},week:{dow:1,doy:4}});

const app = new Vue({
	el: '#app',
	data: {
        homeFooterSelection: 1,
        currentTab: 0,
        currentLi: 0,
        phone: 0,       // MON NUMERO
        talkNumber: 0, // NUMERO DU DESTINATAIRE
        currentTalk: 0,
        textMessage: '',
		d: {
            messages: [
                
            ],
            talks: [

            ]
		},
    },
    created() {
        this.updatePlayerMessages();
        this.timer = setInterval(this.updatePlayerMessages, 500);

        window.addEventListener('keydown', (e) => {
            if(e.key == 'Backspace') {
                var reply = document.getElementById("reply");

                if(document.activeElement === reply)
                    return;

                if(this.currentTab == 0)
                {
                    mp.trigger("cCloseCef");
                }
                if(this.currentTab == 3)
                    this.currentTab = 0;
                if(this.currentTab == 30)
                    this.currentTab = 3;
            }
            if(e.key == 'ArrowLeft') {
            
                if(this.currentTab == 0)
                {
                    this.homeFooterSelection--;
                    if(this.homeFooterSelection < 1) this.homeFooterSelection = 4;
                }
            }
            if(e.key == 'ArrowRight') {
                if(this.currentTab == 0)
                {
                    this.homeFooterSelection++;
                    if(this.homeFooterSelection > 4) this.homeFooterSelection = 1;
                }
            }
            if(e.key == 'ArrowDown') {
                if(this.currentTab == 3)
                {
                    this.currentLi++;

                    for(let i = 0; i < this.d.talks.length; i++)
                    {
                        if(this.currentLi == i) this.currentTalk = this.d.talks[i].id;
                    }
                }
                if(this.currentTab == 30)
                    this.scrollToBottom("chat");
                    
            }
            if(e.key == 'ArrowUp') {
                if(this.currentTab == 3)
                {
                    this.currentLi--;
                    if(this.currentLi <= 0)
                        this.currentLi = 0;

                    for(let i = 0; i < this.d.talks.length; i++)
                    {
                        if(this.currentLi == i) this.currentTalk = this.d.talks[i].id;
                    }
                }
                if(this.currentTab == 30)
                    this.scrollToTop("chat");
                    
            }
            if(e.key == 'Enter') {
                // ENTRER DANS LES MESSAGES
                if(this.currentTab == 0)
                {
                    for(let i = 0; i < this.d.talks.length; i++)
                    {
                        if(this.currentLi == i) this.currentTalk = this.d.talks[i].id;
                    }

                    return this.currentTab = 3;
                }


                // ENTRER DANS UNE CONVERSATION
                if(this.currentTab == 3)
                {
                    this.currentTab = 30;
                    for(let i = 0; i < this.d.talks.length; i++)
                    {
                        if(i != this.currentLi) continue;
                        
                        this.talkNumber = this.phone === this.d.talks[i].receiver ? this.d.talks[i].sender : this.d.talks[i].receiver;
                    }
                    return 1;
                }
                if(this.currentTab == 30) 
                {
                    if(document.activeElement.id == 'btnSms')
                    {
                        const data = {
                            talk: this.currentTalk,
                            sender: this.phone,
                            receiver: this.talkNumber,
                            text: this.textMessage,
                            talkId: this.currentTalk
                        }

                        mp.trigger("cMisc-CallServerEvent", "sPhone-sendMessage", JSON.stringify(data));

                        this.textMessage = '';
                        this.scrollBottom;
                    }
                }
            }
        });
    }, 
	computed: {
		currentTabComponent: function () {
			return 'tab' + this.currentTab;
		},
	},
	methods: {
        updatePlayerMessages: function() {
            const data = {
                talkId: this.currentTalk,
            }

            mp.trigger("cMisc-CallServerEvent", "sPhone-updatePlayerMessages", JSON.stringify(data));
        },
        scrollBottom: function(id) {
            var element = document.getElementById(id);
            element.scrollTop = element.scrollHeight;
        },
        scrollToBottom: function(id) {
            var element = document.getElementById(id);
            element.scrollTop += 20;
        },
        scrollToTop: function(id) {
            var element = document.getElementById(id);
            element.scrollTop -= 20;
        },
    },
    filters: {
		format(date) {
            var now = moment();

            if(moment(date).diff(now, 'days') <= 0)
                return moment(date).format('LT');
            else if(moment(date).diff(now, 'days') <= 1)
                return moment(date).format('Hier');
            else if(moment(date).diff(now, 'days') <= 7)
                return moment(date).format('ddd');
            else if(moment(date).diff(now, 'days') >= 7)
                return moment(date).format('D/MM/YYYY');
		},
	},
});
</script>